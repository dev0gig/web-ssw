<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwangerschafts-Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Using a more modern, clean font */
        body {
            font-family: 'Inter', sans-serif;
            /* Add a background that makes the blur effect visible */
            background-image: radial-gradient(circle at top right, rgb(127 29 29 / 0.2), transparent),
                              radial-gradient(circle at bottom left, rgb(29 78 216 / 0.2), transparent);
            background-attachment: fixed; /* Keep the gradient fixed during scroll */
        }
        /* Glassmorphism Effect */
        .glass-effect {
            background: rgba(40, 48, 66, 0.5); /* A semi-transparent slate-like color */
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .week-cell {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(2px);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: box-shadow 0.2s ease-in-out, background-color 0.2s;
        }
        .week-cell:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Brighter hover */
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        .selected-week {
            background-color: rgba(20, 184, 166, 0.6); /* Teal-500 with opacity */
            color: #ffffff;
            border-color: #2dd4bf; /* Teal-400 */
            box-shadow: 0 0 15px rgba(20, 184, 166, 0.4);
        }
        /* Enhanced current week styling */
        .current-week {
            background-color: rgba(168, 85, 247, 0.6); /* Vibrant Purple with opacity */
            color: #ffffff;
            border-color: #c084fc;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }
        .trimester-1 {
            background-color: rgb(234 179 8 / 0.1); /* yellow-500 with 10% opacity */
            border-color: rgb(234 179 8 / 0.3);
        }
        .trimester-2 {
            background-color: rgb(34 197 94 / 0.1); /* green-500 with 10% opacity */
            border-color: rgb(34 197 94 / 0.3);
        }
        .trimester-3 {
            background-color: rgb(236 72 153 / 0.1); /* pink-500 with 10% opacity */
            border-color: rgb(236 72 153 / 0.3);
        }
        .date-input {
            color-scheme: dark; /* Helps with date picker styling in dark mode */
            background-color: rgba(51, 65, 85, 0.5); /* slate-700 with opacity */
        }
        #progressBar {
            transition: width 0.5s ease-in-out;
        }
        /* Simple modal animation */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-violet-400">Schwangerschafts-Tracker</h1>

        <div class="mt-8 lg:grid lg:grid-cols-5 lg:gap-8">
            <!-- Left Column: Info & Tools -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Main Info Card -->
                <div id="infoDisplay" class="glass-effect border-l-4 border-sky-500 p-4 sm:p-6 rounded-xl space-y-2">
                    <p><span class="font-medium text-slate-400">Erster Tag der letzten Regel:</span> <span id="lmpDisplay" class="font-bold text-slate-100"></span></p>
                    <p><span class="font-medium text-slate-400">Aktuelle Schwangerschaftswoche:</span> <span id="currentSsw" class="font-bold text-slate-100"></span></p>
                    <p><span class="font-medium text-slate-400">Errechneter Entbindungstermin:</span> <span id="dueDate" class="font-bold text-slate-100"></span></p>
                    <p class="mt-3 pt-3 border-t border-sky-500/20"><span class="font-medium text-slate-400">Noch:</span> <span id="countdown" class="font-bold text-slate-100"></span></p>
                </div>

                <!-- Progress Bar -->
                <div>
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-semibold text-slate-400">Fortschritt</span>
                        <span id="progressPercentage" class="font-bold text-violet-400">0%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="bg-violet-500 h-3 rounded-full"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-1 text-slate-500">
                        <span>Woche 1</span>
                        <span>Woche 40</span>
                    </div>
                </div>

                <!-- Date Converter Card -->
                <div class="glass-effect p-4 sm:p-6 rounded-xl">
                    <h2 class="text-2xl font-semibold text-center mb-4 text-violet-400">Datum in SSW umrechnen</h2>
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <label for="date-search-input" class="font-semibold text-slate-400">Wähle ein Datum:</label>
                        <input type="date" id="date-search-input" class="date-input border border-slate-600 rounded-md p-2 text-slate-200">
                    </div>
                    <div id="date-search-result" class="text-center mt-4 text-slate-400 min-h-[2rem]">
                        <p>Wähle ein Datum, um die entsprechende SSW zu sehen.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Calendar -->
            <div class="lg:col-span-3 mt-8 lg:mt-0">
                <div class="space-y-4">
                    <h2 class="text-2xl font-semibold text-center text-violet-400">Kalender der Schwangerschaft</h2>
                    <div id="weekInfoDisplay" class="glass-effect text-center p-4 rounded-xl min-h-[3.5rem] flex items-center justify-center">
                        <p class="text-slate-400">Klicke auf eine Woche, um die genauen Daten anzuzeigen.</p>
                    </div>
                    <div id="calendar" class="grid grid-cols-5 sm:grid-cols-7 md:grid-cols-10 gap-2">
                        <!-- Calendar weeks will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Info Modal (position fixed, can be outside the main layout grid) -->
    <div id="weeklyInfoModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-effect border-l-4 border-amber-500 p-4 sm:p-6 rounded-xl max-w-2xl w-full relative" style="animation: fade-in-up 0.3s ease-out forwards;">
            <button id="closeModalBtn" class="absolute top-2 right-3 text-slate-400 hover:text-white text-3xl font-light leading-none">&times;</button>
            <h3 class="text-xl font-semibold mb-3 text-amber-400">Was passiert in der <span id="weeklyInfoWeekNumber"></span>. SSW?</h3>
            <p id="weeklyInfoText" class="text-base leading-relaxed text-slate-300 max-h-[60vh] overflow-y-auto pr-2">Informationen zur aktuellen Woche werden hier geladen...</p>
            <div id="weeklyStats" style="display: none;" class="mt-4 pt-4 border-t border-amber-500/20 flex flex-col sm:flex-row sm:justify-around text-center gap-4">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <script>
        const infoDisplay = document.getElementById('infoDisplay');
        const lmpDisplay = document.getElementById('lmpDisplay');
        const currentSswSpan = document.getElementById('currentSsw');
        const dueDateSpan = document.getElementById('dueDate');
        const calendarDiv = document.getElementById('calendar');
        const weekInfoDisplay = document.getElementById('weekInfoDisplay');
        const dateSearchInput = document.getElementById('date-search-input');
        const dateSearchResult = document.getElementById('date-search-result');
        const weeklyInfoModal = document.getElementById('weeklyInfoModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const weeklyInfoWeekNumber = document.getElementById('weeklyInfoWeekNumber');
        const weeklyInfoText = document.getElementById('weeklyInfoText');
        const weeklyStats = document.getElementById('weeklyStats');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const countdownSpan = document.getElementById('countdown');

        // Fixed LMP Date: April 10, 2025
        const fixedLmpDate = new Date('2025-04-10T00:00:00'); // Use T00:00:00 to avoid timezone issues

        // Data for weekly development
        const weeklyDevelopmentInfo = {
            1: { description: "Die Befruchtung hat noch nicht stattgefunden. Diese Woche wird zur Berechnung des Geburtstermins gezählt, beginnend mit dem ersten Tag Ihrer letzten Periode." },
            2: { description: "Gegen Ende dieser Woche findet wahrscheinlich der Eisprung statt. Wenn eine Samenzelle auf die Eizelle trifft, beginnt die Reise des neuen Lebens." },
            3: { description: "Die befruchtete Eizelle wandert durch den Eileiter und teilt sich kontinuierlich. Am Ende der Woche nistet sie sich in der Gebärmutterwand ein." },
            4: { description: "Der Embryo ist winzig, aber die Schwangerschaftshormone sind nun im Urin nachweisbar. Ein Test wäre jetzt positiv. Die grundlegenden Strukturen wie das Neuralrohr bilden sich.", size: "Mohnsamengröße", weight: "kaum messbar" },
            5: { description: "Das Herz Ihres Babys beginnt zu schlagen und Blut zu pumpen. Es ist etwa so groß wie ein Sesamsamen und die Hauptorgane beginnen sich zu entwickeln.", size: "1-2 mm", weight: "kaum messbar" },
            6: { description: "Das Baby ist jetzt so groß wie eine Linse. Arm- und Beinknospen sind sichtbar und Gesichtszüge wie Augen und Nasenlöcher beginnen sich zu formen.", size: "4 mm", weight: "< 1 g" },
            7: { description: "Die Größe entspricht nun einer Heidelbeere. Hände und Füße entwickeln sich, sehen aber noch wie kleine Paddel aus. Das Gehirn wächst rasant.", size: "8 mm", weight: "< 1 g" },
            8: { description: "Alle wichtigen Organe sind angelegt und beginnen zu arbeiten. Der Embryo bewegt sich, auch wenn Sie es noch nicht spüren können. Er wird nun offiziell als Fötus bezeichnet.", size: "1,6 cm", weight: "1 g" },
            9: { description: "Der Fötus ist so groß wie eine Weintraube. Die Gelenke (Ellbogen, Knie) sind ausgebildet und die Finger und Zehen werden länger.", size: "2,3 cm", weight: "2 g" },
            10: { description: "Die kritischste Phase der Entwicklung ist abgeschlossen. Der Fötus kann seine Gliedmaßen beugen und die Fingernägel beginnen zu wachsen.", size: "3,1 cm", weight: "4 g" },
            11: { description: "Das Baby ist jetzt etwa so groß wie eine Feige. Es kann gähnen, schlucken und sich strecken. Die Geschlechtsorgane entwickeln sich.", size: "4,1 cm", weight: "7 g" },
            12: { description: "Die meisten Organe sind vollständig ausgebildet und müssen nur noch wachsen. Das Risiko einer Fehlgeburt sinkt erheblich. Das Baby ist ca. 5-6 cm groß.", size: "5,4 cm", weight: "14 g" },
            13: { description: "Das erste Trimester endet. Der Fötus hat nun Fingerabdrücke. Die Stimmbänder beginnen sich zu entwickeln.", size: "7,4 cm", weight: "23 g" },
            14: { description: "Willkommen im zweiten Trimester! Das Baby kann nun Grimassen schneiden und die Nieren produzieren Urin. Es ist ca. 9 cm groß.", size: "8,7 cm", weight: "43 g" },
            15: { description: "Die Knochen werden härter und das Baby kann Licht durch die geschlossenen Augenlider wahrnehmen. Es ist jetzt so groß wie ein Apfel.", size: "10,1 cm", weight: "70 g" },
            16: { description: "Sie könnten die ersten zarten Kindsbewegungen spüren (Flattern). Das Nervensystem ist weiter ausgereift.", size: "11,6 cm", weight: "100 g" },
            17: { description: "Das Skelett wandelt sich von Knorpel zu Knochen. Der Fötus legt an Gewicht zu und bildet eine schützende Fettschicht.", size: "13 cm", weight: "140 g" },
            18: { description: "Die Ohren sind an der richtigen Position und das Baby kann wahrscheinlich hören. Sprechen oder singen Sie ihm etwas vor!", size: "14,2 cm", weight: "190 g" },
            19: { description: "Eine schützende, wachsartige Schicht namens Vernix caseosa bildet sich auf der Haut des Babys. Es ist jetzt ca. 15 cm lang.", size: "15,3 cm", weight: "240 g" },
            20: { description: "Halbzeit! Der große Ultraschall steht oft an, bei dem Sie vielleicht das Geschlecht erfahren können. Das Baby schluckt regelmäßig Fruchtwasser.", size: "25,6 cm", weight: "300 g" },
            21: { description: "Die Bewegungen werden kräftiger. Das Baby entwickelt einen regelmäßigen Schlaf-Wach-Rhythmus.", size: "26,7 cm", weight: "360 g" },
            22: { description: "Das Baby sieht nun wie eine Miniatur-Version eines Neugeborenen aus. Lippen, Augenbrauen und Augenlider sind deutlich erkennbar.", size: "27,8 cm", weight: "430 g" },
            23: { description: "Die Lungen entwickeln sich weiter und produzieren Surfactant, eine Substanz, die beim Atmen nach der Geburt hilft. Das Hörvermögen ist gut entwickelt.", size: "29 cm", weight: "500 g" },
            24: { description: "Die Überlebenschancen bei einer Frühgeburt steigen ab dieser Woche deutlich an. Das Baby wiegt etwa 600 Gramm.", size: "30 cm", weight: "600 g" },
            25: { description: "Das Baby reagiert auf bekannte Stimmen und Geräusche. Die Haut wird weniger durchsichtig und füllt sich mit Fett.", size: "34,6 cm", weight: "660 g" },
            26: { description: "Die Augen öffnen sich! Das Baby kann nun zwischen hell und dunkel unterscheiden.", size: "35,6 cm", weight: "760 g" },
            27: { description: "Das zweite Trimester neigt sich dem Ende zu. Das Gehirn ist sehr aktiv und das Baby übt Atembewegungen.", size: "36,6 cm", weight: "875 g" },
            28: { description: "Willkommen im dritten Trimester! Das Baby hat gute Überlebenschancen, sollte es jetzt geboren werden. Es wiegt nun etwa 1 kg.", size: "37,6 cm", weight: "1 kg" },
            29: { description: "Die Knochen sind fast vollständig entwickelt. Das Baby nimmt schnell an Gewicht zu und benötigt viel Kalzium.", size: "38,6 cm", weight: "1,2 kg" },
            30: { description: "Das Baby kann seinen Kopf von einer Seite zur anderen drehen. Das Lanugo-Haar, das seinen Körper bedeckt hat, beginnt zu verschwinden.", size: "39,9 cm", weight: "1,3 kg" },
            31: { description: "Die zentralen Nervensystemverbindungen reifen weiter, was dem Baby ermöglicht, die Körpertemperatur zu regulieren.", size: "41,1 cm", weight: "1,5 kg" },
            32: { description: "Die Zehen- und Fingernägel sind vollständig ausgebildet. Das Baby übt das Atmen, indem es Fruchtwasser ein- und ausatmet.", size: "42,4 cm", weight: "1,7 kg" },
            33: { description: "Die Pupillen des Babys können sich bei Lichteinfall verengen und erweitern. Die Knochen härten weiter aus, der Schädel bleibt jedoch weich und flexibel für die Geburt.", size: "43,7 cm", weight: "1,9 kg" },
            34: { description: "Die Lungen sind fast vollständig entwickelt. Wenn das Baby jetzt geboren würde, hätte es wahrscheinlich nur geringe Atemprobleme.", size: "45 cm", weight: "2,1 kg" },
            35: { description: "Das Baby nimmt pro Woche etwa 200-250 Gramm zu. Es wird enger in der Gebärmutter, die Bewegungen fühlen sich anders an.", size: "46,2 cm", weight: "2,4 kg" },
            36: { description: "Das Baby sinkt tiefer ins Becken ('Senkwehen'). Dies kann das Atmen für die Mutter erleichtern.", size: "47,4 cm", weight: "2,6 kg" },
            37: { description: "Die Schwangerschaft gilt nun als 'termingerecht'. Das Baby ist bereit für die Geburt.", size: "48,6 cm", weight: "2,9 kg" },
            38: { description: "Das Baby hat einen festen Griff. Das Gehirn wiegt jetzt etwa 400 Gramm und entwickelt sich auch nach der Geburt weiter.", size: "49,8 cm", weight: "3,1 kg" },
            39: { description: "Die schützende Vernix-Schicht und das Lanugo-Haar sind größtenteils verschwunden. Das Baby legt weiterhin Fettreserven an.", size: "50,7 cm", weight: "3,3 kg" },
            40: { description: "Der errechnete Termin ist da! Aber keine Sorge, nur wenige Babys kommen genau an diesem Tag. Die Geburt kann jederzeit beginnen.", size: "51,2 cm", weight: "3,5 kg" }
        };

        // Function to calculate SSW (Schwangerschaftswoche)
        function calculateSsw(lmpDate, currentDate) {
            // Calculate the difference in milliseconds. Can be negative.
            const diffTime = currentDate.getTime() - lmpDate.getTime();
            // Convert to days. Math.floor handles rounding correctly for both positive and negative diffs.
            const daysSinceLmp = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (daysSinceLmp < 0) {
                // Return a clear indicator that the date is before the LMP
                return { weeks: -1, days: -1, totalDays: daysSinceLmp };
            }

            const weeks = Math.floor(daysSinceLmp / 7);
            const days = daysSinceLmp % 7;
            return { weeks, days, totalDays: daysSinceLmp };
        }

        // Function to calculate the estimated due date (LMP + 280 days)
        function calculateDueDate(lmpDate) {
            const dueDate = new Date(lmpDate);
            dueDate.setDate(dueDate.getDate() + 280); // 40 weeks * 7 days/week = 280 days
            return dueDate;
        }

        // Function to get the date range for a specific week
        function getWeekDateRange(weekNumber, lmpDate) {
            const startDate = new Date(lmpDate);
            // Week 1 starts on day 0 from LMP. Week `n` starts on day `(n-1) * 7`.
            startDate.setDate(startDate.getDate() + (weekNumber - 1) * 7);

            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            return { startDate, endDate };
        }

        // Function to get trimester label based on week number
        function getTrimesterLabel(week) {
            if (week >= 1 && week <= 13) {
                return '1. Trimester';
            } else if (week >= 14 && week <= 27) {
                return '2. Trimester';
            } else if (week >= 28 && week <= 40) {
                return '3. Trimester';
            }
            return '';
        }

        // Function to get trimester CSS class
        function getTrimesterClass(week) {
            if (week >= 1 && week <= 13) {
                return 'trimester-1';
            } else if (week >= 14 && week <= 27) {
                return 'trimester-2';
            } else if (week >= 28 && week <= 40) {
                return 'trimester-3';
            }
            return '';
        }

        // Function to render the app
        function renderApp() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            // Display fixed LMP date
            lmpDisplay.textContent = fixedLmpDate.toLocaleDateString('de-DE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Calculate and display current SSW and Due Date
            const { weeks: currentWeeks, days: currentDays, totalDays: currentTotalDays } = calculateSsw(fixedLmpDate, today);
            const dueDate = calculateDueDate(fixedLmpDate);

            currentSswSpan.textContent = `${currentWeeks}+${currentDays} SSW`;
            dueDateSpan.textContent = dueDate.toLocaleDateString('de-DE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Calculate and display countdown
            const remainingTime = dueDate.getTime() - today.getTime();
            // Use Math.ceil to count the current day as a full day remaining
            const remainingTotalDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));

            if (remainingTotalDays > 0) {
                const remainingWeeks = Math.floor(remainingTotalDays / 7);
                const remainingDaysInWeek = remainingTotalDays % 7;
                countdownSpan.textContent = `${remainingWeeks} Wochen & ${remainingDaysInWeek} Tage (${remainingTotalDays} Tage gesamt)`;
            } else if (remainingTotalDays === 0) {
                countdownSpan.textContent = "Heute ist der errechnete Termin!";
            } else {
                const daysOverdue = Math.abs(remainingTotalDays);
                const dayText = daysOverdue === 1 ? 'Tag' : 'Tage';
                countdownSpan.textContent = `Termin um ${daysOverdue} ${dayText} überschritten`;
            }

            // Calculate and display progress bar
            const totalPregnancyDays = 280;
            let progressPercent = (currentTotalDays / totalPregnancyDays) * 100;
            // Clamp the value between 0 and 100
            progressPercent = Math.max(0, Math.min(100, progressPercent));

            progressBar.style.width = `${progressPercent}%`;
            progressPercentage.textContent = `${Math.round(progressPercent)}%`;

            // Render Calendar
            calendarDiv.innerHTML = ''; // Clear previous calendar
            const totalWeeksToDisplay = 41; // Display up to week 40, plus one for buffer/due date visualization

            for (let i = 0; i < totalWeeksToDisplay; i++) {
                const weekNumber = i + 1;
                const weekCell = document.createElement('div');
                weekCell.dataset.week = weekNumber;
                weekCell.className = 'week-cell flex flex-col items-center justify-center p-2 rounded-lg cursor-pointer min-h-[80px] text-center';

                // Add trimester class
                weekCell.classList.add(getTrimesterClass(weekNumber));

                // Check if this is the current week
                if (weekNumber === currentWeeks + 1) { // +1 because currentWeeks is 0-indexed for full weeks passed
                    weekCell.classList.add('current-week');
                }

                const weekNumberSpan = document.createElement('span');
                weekNumberSpan.className = 'font-bold text-slate-200';
                weekNumberSpan.textContent = `${weekNumber}`;
                weekCell.appendChild(weekNumberSpan);

                const trimesterLabel = document.createElement('span');
                trimesterLabel.className = 'text-xs text-slate-400 mt-1';
                trimesterLabel.textContent = getTrimesterLabel(weekNumber);
                weekCell.appendChild(trimesterLabel);

                calendarDiv.appendChild(weekCell);
            }
        }

        // Render the app on page load
        document.addEventListener('DOMContentLoaded', renderApp);

        // --- Modal Logic ---
        function openModal(weekNumber) {
            const info = weeklyDevelopmentInfo[weekNumber];

            if (info) {
                weeklyInfoWeekNumber.textContent = weekNumber;
                weeklyInfoText.textContent = info.description;

                let statsHtml = '';
                if (info.size) {
                    statsHtml += `<div><span class="block text-sm font-medium text-amber-500">Größe</span><span class="text-lg font-semibold text-amber-300">${info.size}</span></div>`;
                }
                if (info.weight) {
                    statsHtml += `<div><span class="block text-sm font-medium text-amber-500">Gewicht</span><span class="text-lg font-semibold text-amber-300">${info.weight}</span></div>`;
                }

                if (statsHtml) {
                    weeklyStats.innerHTML = statsHtml;
                    weeklyStats.style.display = 'flex';
                } else {
                    weeklyStats.style.display = 'none';
                }
            } else {
                // Handle cases for weeks without specific data (e.g., week 41)
                weeklyInfoWeekNumber.textContent = weekNumber;
                weeklyInfoText.textContent = "Für diese Woche liegen keine spezifischen Informationen vor. Der errechnete Termin ist möglicherweise überschritten.";
                weeklyStats.style.display = 'none';
            }

            weeklyInfoModal.classList.remove('hidden');
        }

        function closeModal() {
            weeklyInfoModal.classList.add('hidden');
        }

        closeModalBtn.addEventListener('click', closeModal);
        weeklyInfoModal.addEventListener('click', (event) => {
            if (event.target === weeklyInfoModal) closeModal(); // Close if clicking on the overlay
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !weeklyInfoModal.classList.contains('hidden')) closeModal();
        });

        // Event listener for calendar week clicks
        calendarDiv.addEventListener('click', (event) => {
            const weekCell = event.target.closest('.week-cell');
            if (!weekCell) return;

            // Remove 'selected-week' from previously selected cell
            const currentlySelected = document.querySelector('.selected-week');
            if (currentlySelected) {
                currentlySelected.classList.remove('selected-week');
            }

            // Add 'selected-week' to the clicked cell
            weekCell.classList.add('selected-week');

            const weekNumber = parseInt(weekCell.dataset.week, 10);
            
            openModal(weekNumber); // Open the modal with info for the clicked week

            const { startDate, endDate } = getWeekDateRange(weekNumber, fixedLmpDate);

            const options = { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' };
            const formattedStartDate = startDate.toLocaleDateString('de-DE', options);
            const formattedEndDate = endDate.toLocaleDateString('de-DE', options);
            
            weekInfoDisplay.innerHTML = `<div class="flex flex-col sm:flex-row sm:gap-2 items-center"><span class="font-bold text-slate-200">Woche ${weekNumber}:</span><span class="text-slate-400">${formattedStartDate} - ${formattedEndDate}</span></div>`;
        });

        // Event listener for the date search input
        dateSearchInput.addEventListener('change', (event) => {
            const selectedDateValue = event.target.value;
            if (!selectedDateValue) {
                dateSearchResult.innerHTML = '<p>Wähle ein Datum, um die entsprechende SSW zu sehen.</p>';
                return;
            }

            // The input value is 'YYYY-MM-DD'. To avoid timezone issues where this might be interpreted as UTC midnight,
            // we construct the date from parts, which the Date constructor treats as local time.
            const parts = selectedDateValue.split('-');
            const selectedDate = new Date(parts[0], parseInt(parts[1], 10) - 1, parts[2]);
            selectedDate.setHours(0, 0, 0, 0); // Normalize to the start of the day

            if (isNaN(selectedDate.getTime())) { // Check for invalid date
                dateSearchResult.innerHTML = '<p>Ungültiges Datum. Bitte versuche es erneut.</p>';
                return;
            }

            const { weeks, days } = calculateSsw(fixedLmpDate, selectedDate);

            const formattedSelectedDate = selectedDate.toLocaleDateString('de-DE', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            if (weeks < 0) {
                dateSearchResult.innerHTML = `<p>Das Datum ${formattedSelectedDate} liegt vor dem Beginn der Schwangerschaft.</p>`;
            } else if (weeks >= 41) {
                dateSearchResult.innerHTML = `<p>Das Datum ${formattedSelectedDate} liegt nach der 41. Woche.</p>`;
            } else {
                // Use weeks + 1 for human-readable week number (e.g., 0 weeks passed = 1st week)
                dateSearchResult.innerHTML = `<p>Der ${formattedSelectedDate} ist in der <strong>${weeks + 1}. SSW</strong> (genau: ${weeks}+${days}).</p>`;
            }
        });
    </script>
</body>
</html>
